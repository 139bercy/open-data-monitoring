-- Identifier les points de friction du catalogue.
\COPY (SELECT p.name as platform, COUNT(*) as total_datasets, COUNT(*) FILTER (WHERE dq.is_slug_valid IS FALSE) as invalid_slugs, ROUND(AVG(dv.popularity_score)::numeric, 2) as avg_popularity, COUNT(*) FILTER (WHERE dv.views_count = 0 AND dv.timestamp < NOW() - INTERVAL '6 months') as ghost_datasets, COUNT(*) FILTER (WHERE d.published IS TRUE) as published_count FROM datasets d JOIN platforms p ON p.id = d.platform_id LEFT JOIN dataset_quality dq ON d.id = dq.dataset_id LEFT JOIN (SELECT DISTINCT ON (dataset_id) dataset_id, popularity_score, views_count, timestamp FROM dataset_versions ORDER BY dataset_id, timestamp DESC) dv ON d.id = dv.dataset_id WHERE d.deleted IS FALSE GROUP BY p.name ORDER BY total_datasets DESC) TO STDOUT WITH CSV HEADER;
