-- Identifier le Top 20 des datasets qui "buzzent" cette semaine.
\COPY (WITH weekly_delta AS (SELECT d.id, d.slug, p.name as platform, MIN(dv.timestamp) as start_time, MAX(dv.timestamp) as end_time, MIN(dv.views_count) as start_views, MAX(dv.views_count) as end_views, MIN(dv.followers_count) as start_followers, MAX(dv.followers_count) as end_followers FROM dataset_versions dv JOIN datasets d ON d.id = dv.dataset_id JOIN platforms p ON p.id = d.platform_id WHERE dv.timestamp >= CURRENT_DATE - INTERVAL '1 week' AND d.deleted IS FALSE GROUP BY d.id, d.slug, p.name) SELECT slug, platform, (end_views - start_views) as weekly_views_gain, (end_followers - start_followers) as weekly_followers_gain, ROUND(((end_views - start_views)::float / NULLIF(start_views, 0) * 100)::numeric, 2) as growth_percentage FROM weekly_delta WHERE (end_views - start_views) > 0 ORDER BY weekly_views_gain DESC LIMIT 20) TO STDOUT WITH CSV HEADER;
