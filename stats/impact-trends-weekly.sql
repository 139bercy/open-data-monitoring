-- Identifier le Top 20 des datasets qui "buzzent" cette semaine.
-- Adaptation multi-plateforme : DataGouv (Views) vs ODS (API Calls + Downloads)
\COPY (WITH weekly_delta AS (SELECT d.id, d.slug, p.type as platform_type, p.name as platform, MIN(dv.timestamp) as start_time, MAX(dv.timestamp) as end_time, MIN(dv.views_count) as start_views, MAX(dv.views_count) as end_views, MIN(dv.api_calls_count) as start_api, MAX(dv.api_calls_count) as end_api, MIN(dv.downloads_count) as start_dl, MAX(dv.downloads_count) as end_dl, MIN(dv.followers_count) as start_followers, MAX(dv.followers_count) as end_followers FROM dataset_versions dv JOIN datasets d ON d.id = dv.dataset_id JOIN platforms p ON p.id = d.platform_id WHERE dv.timestamp >= CURRENT_DATE - INTERVAL '1 week' AND d.deleted IS FALSE GROUP BY d.id, d.slug, p.type, p.name) SELECT slug, platform, CASE WHEN platform_type = 'opendatasoft' THEN (end_api - start_api) + (end_dl - start_dl) ELSE (end_views - start_views) END as impact_gain, (end_followers - start_followers) as weekly_followers_gain, platform_type as source_metric_type FROM weekly_delta WHERE (CASE WHEN platform_type = 'opendatasoft' THEN (end_api - start_api) + (end_dl - start_dl) ELSE (end_views - start_views) END) > 0 ORDER BY impact_gain DESC LIMIT 20) TO STDOUT WITH CSV HEADER;
