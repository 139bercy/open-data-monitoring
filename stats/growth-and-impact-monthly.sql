-- Mesurer la croissance mensuelle (Deltas) des vues, téléchargements et appels API par plateforme.
\COPY (WITH monthly_metrics AS (SELECT date_trunc('month', dv.timestamp) as month, p.name as platform_name, p.type as platform_type, dv.dataset_id, MIN(dv.downloads_count) as start_downloads, MAX(dv.downloads_count) as end_downloads, MIN(dv.api_calls_count) as start_api_calls, MAX(dv.api_calls_count) as end_api_calls, MIN(dv.views_count) as start_views, MAX(dv.views_count) as end_views, MAX(dv.popularity_score) as avg_popularity FROM dataset_versions dv JOIN datasets d ON d.id = dv.dataset_id JOIN platforms p ON p.id = d.platform_id WHERE d.deleted IS FALSE GROUP BY 1, 2, 3, 4) SELECT month, platform_name, platform_type, SUM(end_downloads - start_downloads) as monthly_downloads, SUM(end_api_calls - start_api_calls) as monthly_api_calls, SUM(end_views - start_views) as monthly_views, ROUND(AVG(avg_popularity)::numeric, 2) as platform_avg_popularity, COUNT(DISTINCT dataset_id) as active_datasets FROM monthly_metrics GROUP BY 1, 2, 3 ORDER BY 1 DESC, 4 DESC) TO STDOUT WITH CSV HEADER;
